// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & ADMIN MODELS
// ============================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  firstName        String
  lastName         String
  password         String?
  googleId         String?   @unique
  avatar           String?
  role             UserRole  @default(STUDENT)
  status           UserStatus @default(ACTIVE)
  isEmailVerified  Boolean   @default(false)
  accessAll        Boolean   @default(false)
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  enrollments      Enrollment[]
  coursesCreated   Course[]     @relation("InstructorCourses")

  // Vault relations
  vaultDiscussions VaultDiscussion[] @relation("UserDiscussions")
  vaultComments    VaultComment[]    @relation("UserComments")
  vaultLikes       VaultLike[]       @relation("UserLikes")
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// COURSE MANAGEMENT MODELS
// ============================================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String   @default("BookOpen")
  iconBgColor String   @default("#3B82F6")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courses     Course[]
}

model Course {
  id           String       @id @default(uuid())
  title        String
  slug         String       @unique
  summary      String?
  description  String?
  thumbnail    String?
  price        Float        @default(0)
  level        CourseLevel  @default(BEGINNER)
  status       CourseStatus @default(DRAFT)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  categoryId   String
  category     Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  instructorId String
  instructor   User         @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Restrict)

  modules      Module[]
  enrollments  Enrollment[]
  documents    Document[]

  @@index([categoryId])
  @@index([instructorId])
  @@index([status])
}

model Module {
  id          String   @id @default(uuid())
  title       String
  summary     String?
  description String?  @db.Text
  content     String?  @db.Text // Base64 encoded video/image content
  contentType String?  // MIME type (e.g., "video/mp4", "image/jpeg")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]
  documents Document[]

  @@index([courseId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  videoUrl    String?
  content     String?  @db.Text // Base64 encoded video/image content (deprecated - use Bunny Stream)
  contentType String?  // MIME type (e.g., "video/mp4", "image/jpeg")
  duration    Int      @default(0) // in seconds
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Bunny Stream fields
  bunnyVideoId   String?  // Bunny Stream video GUID
  bunnyLibraryId String?  // Bunny Stream library ID
  videoStatus    String?  @default("none") // none | uploaded | processing | encoding | finished | failed
  thumbnailUrl   String?  // Auto-generated thumbnail URL from Bunny

  // Relations
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([moduleId])
  @@index([bunnyVideoId])
}

// ============================================
// ENROLLMENT MODEL
// ============================================

model Enrollment {
  id               String           @id @default(uuid())
  price            Float            @default(0)
  status           EnrollmentStatus @default(PENDING)
  progress         Int              @default(0) // percentage 0-100
  enrolledAt       DateTime         @default(now())
  completedAt      DateTime?
  updatedAt        DateTime         @updatedAt

  // Stripe payment tracking
  stripeSessionId  String?          @unique // Stripe Checkout Session ID (cs_xxx)
  stripePaymentId  String?          @unique // Stripe Payment Intent ID (pi_xxx)
  paymentMethod    String?                  // "stripe", "free", "manual"

  // Relations
  userId           String
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId          String
  course            Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([stripeSessionId])
}

// ============================================
// TEAM MEMBER MODEL
// ============================================

model TeamMember {
  id          String   @id @default(uuid())
  name        String
  role        String
  description String?
  image       String?  @db.Text
  email       String?
  facebook    String?
  linkedin    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// TESTIMONIAL MODEL
// ============================================

model Testimonial {
  id              String   @id @default(uuid())
  name            String
  content         String   @db.Text
  rating          Int      @default(5) // 1-5
  image           String?  @db.Text
  gender          String   @default("male") // male | female
  showOnHome      Boolean  @default(false)
  showOnAbout     Boolean  @default(false)
  showOnCourses   Boolean  @default(false)
  showOnDashboard Boolean  @default(false)
  isActive        Boolean  @default(true)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// DOCUMENT MODEL
// ============================================

model Document {
  id        String   @id @default(uuid())
  title     String
  fileName  String
  fileSize  Int      @default(0)
  fileType  String
  content   String   @db.Text // Base64 encoded file content
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Polymorphic: exactly one of these should be set
  courseId  String?
  course    Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  moduleId String?
  module   Module?  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  lessonId String?
  lesson   Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([moduleId])
  @@index([lessonId])
}

// ============================================
// SETTINGS MODEL
// ============================================

model Settings {
  id                      String   @id @default("default")
  siteName                String   @default("LKnight")
  logo                    String?
  contactEmail            String   @default("contact@lknight.com")
  supportEmail            String   @default("support@lknight.com")
  currency                String   @default("USD")
  defaultCourseStatus     String   @default("DRAFT")
  enrollmentNotifications Boolean  @default(true)
  marketingEmails         Boolean  @default(false)
  maintenanceMode         Boolean  @default(false)
  updatedAt               DateTime @updatedAt
}

// ============================================
// VAULT (Anonymous Discussion Forum)
// ============================================

model VaultDiscussion {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  category    String   // e.g. "team-wellness", "career-growth"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Author — stored for moderation but never exposed for regular users
  userId String
  user   User   @relation("UserDiscussions", fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  comments VaultComment[]
  likes    VaultLike[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
}

model VaultComment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Author
  userId String
  user   User   @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)

  // Parent discussion
  discussionId String
  discussion   VaultDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  // Self-referencing for nested replies
  parentId String?
  parent   VaultComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  VaultComment[] @relation("CommentReplies")

  likes VaultLike[]

  @@index([userId])
  @@index([discussionId])
  @@index([parentId])
  @@index([createdAt])
}

model VaultLike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation("UserLikes", fields: [userId], references: [id], onDelete: Cascade)

  // Polymorphic — exactly one of these should be set
  discussionId String?
  discussion   VaultDiscussion? @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  commentId String?
  comment   VaultComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Prevent duplicate likes
  @@unique([userId, discussionId])
  @@unique([userId, commentId])
  @@index([discussionId])
  @@index([commentId])
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
}

enum EnrollmentStatus {
  PENDING
  COMPLETED
  REFUNDED
}
